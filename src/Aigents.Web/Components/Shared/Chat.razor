@* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT COMPONENT
   Main chat interface with AI agent
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• *@

@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation

<div class="orb orb-1 orb-chat @(_mode)"></div>

<header class="chat-header">
    <div class="chat-header-inner">
        <button class="back-btn" @onclick="HandleBack">
            <span class="back-arrow">â†</span>
            <span class="logo-text">aigents<span class="logo-au">.au</span></span>
        </button>
        
        <div class="header-right">
            @if (User?.Identity?.Name is not null)
            {
                <div class="user-pill">
                    <span class="user-avatar @(_mode)">@User.Identity.Name[0]</span>
                    <span class="user-name">@User.Identity.Name.Split(' ')[0]</span>
                </div>
            }
            
            <div class="mini-toggle">
                <button class="@BuyToggleClass"
                        @onclick="SetModeBuy">
                    ğŸ 
                </button>
                <button class="@SellToggleClass"
                        @onclick="SetModeSell">
                    ğŸ“ˆ
                </button>
            </div>
        </div>
    </div>
</header>

@if (_showHandoff)
{
    <div class="handoff-banner @(_mode)">
        <div class="handoff-content">
            <span class="handoff-icon">ğŸ¤</span>
            <div class="handoff-text">
                <span class="handoff-title">Ready for the next step?</span>
                <span class="handoff-subtitle">Connect with a human agent</span>
            </div>
        </div>
        <button class="handoff-btn @(_mode)" @onclick="HandleHandoff">Talk to Agent</button>
    </div>
}

<div class="messages-area">
    <div class="messages-inner">
        @if (_messages.Count == 0)
        {
            <div class="welcome">
                <div class="welcome-icon @(_mode)">âœ¦</div>
                <h2 class="welcome-title">Hi @(User?.Identity?.Name?.Split(' ')[0])! ğŸ‘‹</h2>
                <p class="welcome-sub">How can I help you @_mode today?</p>
                
                <div class="suggestions">
                    @foreach (var suggestion in GetSuggestions())
                    {
                        <button class="suggestion-btn" @onclick="() => SendMessage(suggestion.Label)">
                            <span class="suggestion-icon @(_mode)">@suggestion.Icon</span>
                            @suggestion.Label
                        </button>
                    }
                </div>
            </div>
        }
        
        @foreach (var msg in _messages)
        {
            <div class="msg-row @msg.Role">
                <div class="msg @msg.Role @(msg.Role == "user" ? _mode : "")">
                    @msg.Content
                </div>
            </div>
        }
        
        @if (_isLoading)
        {
            <div class="msg-row assistant">
                <div class="msg assistant">
                    <div class="typing-dots">
                        <span class="dot @(_mode)"></span>
                        <span class="dot @(_mode)"></span>
                        <span class="dot @(_mode)"></span>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<div class="input-area">
    <div class="input-container">
        <div class="input-inner">
            <input @bind="_input" 
                   @bind:event="oninput"
                   @onkeypress="HandleKeyPress"
                   placeholder="Message your AI agent..." 
                   class="chat-input" />
            <button class="send-btn @(_mode) @(string.IsNullOrWhiteSpace(_input) ? "disabled" : "")" 
                    @onclick="() => SendMessage()"
                    disabled="@(string.IsNullOrWhiteSpace(_input) || _isLoading)">
                â†‘
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public System.Security.Claims.ClaimsPrincipal? User { get; set; }

    private string _mode = "buy";
    private string _input = "";
    private bool _isLoading;
    private bool _showHandoff;
    private List<ChatMessage> _messages = new();
    private Guid? _conversationId;

    private record ChatMessage(string Role, string Content);
    private record Suggestion(string Icon, string Label);

    private List<Suggestion> GetSuggestions() => _mode == "buy" 
        ? new List<Suggestion>
        {
            new("ğŸ”", "Off-market in Paddington"),
            new("ğŸ ", "Under $1.2M in Bulimba"),
            new("ğŸ“", "Best Gold Coast suburbs"),
            new("ğŸ“ˆ", "High-growth areas")
        }
        : new List<Suggestion>
        {
            new("ğŸ‘¥", "Find sellers in Burleigh"),
            new("ğŸ’°", "Market values in New Farm"),
            new("ğŸ“§", "Create outreach campaign"),
            new("ğŸ”", "Withdrawn listings")
        };

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_input))
        {
            await SendMessage();
        }
    }

    private async Task SendMessage(string? content = null)
    {
        var text = content ?? _input.Trim();
        if (string.IsNullOrWhiteSpace(text) || _isLoading) return;

        _input = "";
        _messages.Add(new ChatMessage("user", text));
        _isLoading = true;
        StateHasChanged();

        try
        {
            var client = HttpClientFactory.CreateClient("api");
            var response = await client.PostAsJsonAsync("/api/chat", new
            {
                ConversationId = _conversationId,
                UserId = Guid.Parse(User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? Guid.Empty.ToString()),
                Messages = _messages.Select(m => new { m.Role, m.Content }),
                Mode = _mode
            });

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ChatResponse>();
                if (result is not null)
                {
                    _conversationId = result.ConversationId;
                    _messages.Add(new ChatMessage("assistant", result.Content));
                    
                    if (_messages.Count >= 6 && !_showHandoff)
                    {
                        _showHandoff = true;
                    }
                }
            }
            else
            {
                _messages.Add(new ChatMessage("assistant", "Sorry, I'm having trouble connecting. Please try again."));
            }
        }
        catch
        {
            _messages.Add(new ChatMessage("assistant", "Sorry, I'm having trouble connecting. Please try again."));
        }

        _isLoading = false;
        StateHasChanged();
    }

    private void HandleBack()
    {
        Navigation.NavigateTo("/logout", forceLoad: true);
    }

    private async Task HandleHandoff()
    {
        // TODO: Call handoff API
        // For now, just show alert
    }

    private void SetModeBuy() => _mode = "buy";
    private void SetModeSell() => _mode = "sell";

    private string BuyToggleClass => _mode == "buy" ? "mini-toggle-btn active buy" : "mini-toggle-btn";
    private string SellToggleClass => _mode == "sell" ? "mini-toggle-btn active sell" : "mini-toggle-btn";

    private record ChatResponse(Guid ConversationId, string Content, int TokensUsed);
}
